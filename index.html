<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Ë®∫ÂØüÊó•„Ç´„É¨„É≥„ÉÄ„Éº">
<title>Ë®∫ÂØüÊó•„Ç´„É¨„É≥„ÉÄ„Éº</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@300;400;500;700&family=Nunito:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #f5f3ef;
    --card-bg: #ffffff;
    --text: #1a1a1a;
    --text-muted: #6b6b6b;
    --border: #e0ddd8;
    --today-bg: rgba(230, 126, 34, 0.25);
    --today-border: rgba(230, 126, 34, 0.5);
    --today-text: #d35400;
    --sunday-text: #c0392b;
    --saturday-text: #2471a3;
    --holiday-text: #c0392b;
    --holiday-bg: #fdf2f2;
    --closure-text: #5a9e6f;
    --closure-bg: #eef7f0;
    --day-count: #c0392b;
    --header-bg: #1a1a1a;
    --header-text: #f5f3ef;
    --shadow: 0 1px 3px rgba(0,0,0,0.06), 0 1px 2px rgba(0,0,0,0.04);
    --shadow-lg: 0 4px 12px rgba(0,0,0,0.08);
    --radius: 10px;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  html {
    font-family: 'M PLUS Rounded 1c', sans-serif;
    font-size: 15px;
    background: var(--bg);
    color: var(--text);
    -webkit-font-smoothing: antialiased;
  }
  body { min-height: 100vh; overflow: hidden; }

  /* === HEADER === */
  .app-header {
    position: fixed; top: 0; left: 0; right: 0; z-index: 100;
    background: var(--header-bg); color: var(--header-text);
    padding: 10px 20px;
    display: flex; align-items: center; justify-content: space-between;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15); height: 48px;
  }
  .app-title {
    font-size: 1rem; font-weight: 600; letter-spacing: 0.05em;
    display: flex; align-items: center; gap: 8px;
  }
  .app-title-icon {
    width: 26px; height: 26px;
    background: linear-gradient(135deg, #5b6abf, #7b8ad0);
    border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 13px;
  }
  .header-center { display: flex; align-items: center; gap: 12px; }
  .header-date {
    font-size: 0.82rem; font-weight: 300; opacity: 0.8;
    font-family: 'Nunito', sans-serif;
  }
  .header-actions { display: flex; gap: 6px; }
  .header-btn {
    background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.15);
    color: var(--header-text); padding: 5px 12px; border-radius: 6px;
    font-size: 0.78rem; font-family: 'M PLUS Rounded 1c', sans-serif;
    cursor: pointer; transition: all 0.15s; white-space: nowrap;
  }
  .header-btn:hover, .header-btn:active { background: rgba(255,255,255,0.2); }
  .mode-toggle {
    display: flex; border-radius: 6px; overflow: hidden;
    border: 1px solid rgba(255,255,255,0.2);
  }
  .mode-toggle-btn {
    background: transparent; border: none; color: rgba(255,255,255,0.5);
    padding: 5px 10px; font-size: 0.72rem;
    font-family: 'M PLUS Rounded 1c', sans-serif;
    cursor: pointer; transition: all 0.15s;
  }
  .mode-toggle-btn.active { background: rgba(255,255,255,0.2); color: white; }

  /* === MAIN === */
  .main-area { position: fixed; top: 48px; left: 0; right: 0; bottom: 0; overflow: hidden; }

  /* === LEGEND === */
  .legend {
    padding: 5px 20px; display: flex; gap: 14px; flex-wrap: wrap;
    font-size: 0.8rem; color: var(--text-muted);
    background: var(--bg); border-bottom: 1px solid var(--border);
  }
  .legend-item { display: flex; align-items: center; gap: 5px; }
  .legend-dot { width: 10px; height: 10px; border-radius: 3px; }

  /* ======================== */
  /* SINGLE MONTH VIEW        */
  /* ======================== */
  .single-view { height: 100%; display: flex; flex-direction: column; }

  .single-view .month-nav {
    display: flex; align-items: center; justify-content: center;
    padding: 4px 20px; background: var(--bg);
  }
  .month-nav-title {
    font-size: 2.2rem; font-weight: 700;
    text-align: center;
    font-family: 'Nunito', sans-serif;
  }
  .month-nav-title .year {
    font-size: 1.2rem; font-weight: 400; color: var(--text-muted);
    margin-left: 8px;
  }

  .single-month-body {
    flex: 1; display: flex; align-items: stretch; justify-content: center;
    padding: 0 10px 10px; overflow: hidden; position: relative;
  }
  .swipe-area {
    flex: 1; display: flex; align-items: stretch; justify-content: center;
    width: 100%; touch-action: pan-y;
  }
  .single-month-card {
    background: var(--card-bg); border-radius: var(--radius);
    box-shadow: var(--shadow-lg); border: 1px solid var(--border);
    width: 100%; max-width: 100%; display: flex; flex-direction: column;
  }
  .single-month-card .month-grid {
    display: grid; grid-template-columns: repeat(7, 1fr);
    padding: 6px 10px 10px; gap: 0; flex: 1; align-content: start;
  }
  .single-month-card .month-grid .day-cell:nth-child(n+8) { border-top: 1px solid var(--border); }
  .single-month-card .month-grid .empty:nth-child(n+8) { border-top: 1px solid var(--border); }

  .single-month-card .weekday-header {
    text-align: center; font-size: 1.1rem; font-weight: 500;
    padding: 4px 0; color: var(--text-muted); letter-spacing: 0.05em;
  }
  .single-month-card .day-cell {
    min-height: 11vh; padding: 6px 2px; border-radius: 8px;
  }
  .single-month-card .day-num { font-size: 2.8rem; font-weight: 700; }
  .single-month-card .day-count { font-size: 0.95rem; margin-top: 1px; font-weight: 600; }
  .single-month-card .day-label { font-size: 0.7rem; margin-top: 1px; }

  /* ======================== */
  /* SCROLL VIEW               */
  /* ======================== */
  .scroll-view { height: 100%; display: flex; flex-direction: column; }
  .scroll-content {
    flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch;
    padding: 12px 20px 80px;
  }
  .scroll-content .calendar-grid {
    max-width: 1200px; margin: 0 auto;
    display: grid; grid-template-columns: repeat(3, 1fr); gap: 14px;
  }
  @media (max-width: 900px) {
    .scroll-content .calendar-grid { grid-template-columns: repeat(2, 1fr); }
  }
  .scroll-content .month-card {
    background: var(--card-bg); border-radius: var(--radius);
    box-shadow: var(--shadow); overflow: hidden; border: 1px solid var(--border);
  }
  .scroll-content .month-header {
    padding: 8px 12px; font-weight: 600; font-size: 0.9rem;
    background: #fafaf8; border-bottom: 1px solid var(--border);
    display: flex; align-items: baseline; gap: 6px;
  }
  .scroll-content .month-header-year {
    font-size: 0.72rem; font-weight: 400; color: var(--text-muted);
    font-family: 'Nunito', sans-serif;
  }
  .scroll-content .month-grid {
    display: grid; grid-template-columns: repeat(7, 1fr); padding: 5px; gap: 1px;
  }
  .scroll-content .month-grid .day-cell:nth-child(n+8) { border-top: 1px solid var(--border); }
  .scroll-content .month-grid .empty:nth-child(n+8) { border-top: 1px solid var(--border); }
  .scroll-content .weekday-header {
    text-align: center; font-size: 0.8rem; font-weight: 500;
    padding: 4px 0; color: var(--text-muted);
  }
  .scroll-content .day-cell { min-height: 52px; padding: 4px 1px; }
  .scroll-content .day-num { font-size: 1.4rem; }
  .scroll-content .day-count { font-size: 0.6rem; }
  .scroll-content .day-label { font-size: 0.5rem; }

  /* ======================== */
  /* SHARED DAY CELL           */
  /* ======================== */
  .weekday-header.sun { color: var(--sunday-text); }
  .weekday-header.sat { color: var(--saturday-text); }

  .day-cell {
    position: relative; text-align: center; border-radius: 6px;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    cursor: pointer; transition: background 0.12s; user-select: none;
  }
  .day-cell:active { background: rgba(0,0,0,0.04); }
  .day-cell.empty { cursor: default; }
  .day-cell.empty:active { background: transparent; }

  .day-num {
    font-weight: 600; line-height: 1.2;
    font-family: 'Nunito', sans-serif;
  }
  .day-count {
    font-weight: 500; font-family: 'Nunito', sans-serif;
    line-height: 1; color: var(--day-count); opacity: 0.85;
  }
  .day-label {
    line-height: 1; font-weight: 400; letter-spacing: -0.02em;
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    max-width: 100%; padding: 0 1px;
  }

  .day-cell.sunday .day-num { color: var(--sunday-text); }
  .day-cell.saturday .day-num { color: var(--saturday-text); }
  .day-cell.holiday { background: var(--holiday-bg); }
  .day-cell.holiday .day-num { color: var(--holiday-text); }
  .day-cell.holiday .day-label { color: var(--holiday-text); opacity: 0.8; }
  .day-cell.closure { background: var(--closure-bg); }
  .day-cell.closure .day-num { color: var(--closure-text); }
  .day-cell.closure .day-label { color: var(--closure-text); opacity: 0.8; }
  .day-cell.regular-closure { background: var(--closure-bg); }
  .day-cell.regular-closure .day-num { color: var(--closure-text); }
  .day-cell.regular-closure .day-label { color: var(--closure-text); opacity: 0.8; }

  .day-cell.today {
    background: var(--today-bg) !important; border-radius: 8px;
    box-shadow: 0 0 0 2px var(--today-border);
  }
  .day-cell.today .day-num { color: var(--today-text) !important; font-weight: 700; }
  .day-cell.today .day-count { color: var(--today-text) !important; opacity: 1; font-weight: 600; }
  .day-cell.today .day-label { color: var(--today-text) !important; }

  /* === TODAY FAB === */
  .today-fab {
    position: fixed; bottom: 20px; right: 20px; z-index: 50;
    background: var(--header-bg); color: var(--header-text);
    border: none; width: 48px; height: 48px; border-radius: 50%;
    font-size: 0.68rem; font-weight: 600;
    font-family: 'M PLUS Rounded 1c', sans-serif;
    cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.25);
    display: flex; align-items: center; justify-content: center;
    transition: transform 0.15s;
  }
  .today-fab:active { transform: scale(0.92); }

  /* === CLOSURE POPUP === */
  .closure-popup-overlay {
    display: none; position: fixed; inset: 0; z-index: 300;
    background: rgba(0,0,0,0.35);
    backdrop-filter: blur(3px); -webkit-backdrop-filter: blur(3px);
  }
  .closure-popup-overlay.open {
    display: flex; align-items: center; justify-content: center;
  }
  .closure-popup {
    background: var(--card-bg); border-radius: 16px;
    box-shadow: var(--shadow-lg); padding: 24px 28px;
    min-width: 320px; max-width: 400px;
    text-align: center;
  }
  .closure-popup-title {
    font-size: 1.1rem; font-weight: 700; margin-bottom: 6px;
  }
  .closure-popup-date {
    font-size: 0.9rem; color: var(--text-muted); margin-bottom: 18px;
    font-family: 'Nunito', sans-serif;
  }
  .closure-popup-label {
    font-size: 0.85rem; font-weight: 500; margin-bottom: 10px;
    color: var(--text-muted);
  }
  .closure-days-grid {
    display: grid; grid-template-columns: repeat(5, 1fr);
    gap: 8px; margin-bottom: 16px;
  }
  .closure-days-btn {
    padding: 12px 8px; border-radius: 10px;
    border: 1.5px solid var(--border); background: var(--card-bg);
    font-size: 1rem; font-weight: 600;
    font-family: 'M PLUS Rounded 1c', sans-serif;
    cursor: pointer; transition: all 0.12s;
  }
  .closure-days-btn:active {
    background: var(--closure-bg); border-color: var(--closure-text);
    color: var(--closure-text);
  }
  .closure-days-btn .sub {
    display: block; font-size: 0.65rem; font-weight: 400;
    color: var(--text-muted); margin-top: 2px;
  }
  .closure-popup-actions {
    display: flex; gap: 8px; justify-content: center;
  }
  .closure-popup-actions button {
    padding: 10px 24px; border-radius: 10px; border: none;
    font-size: 0.9rem; font-family: 'M PLUS Rounded 1c', sans-serif;
    cursor: pointer; font-weight: 500;
  }
  .popup-cancel-btn {
    background: #f0f0f0; color: var(--text);
  }

  /* === SETTINGS === */
  .settings-overlay {
    display: none; position: fixed; inset: 0; z-index: 200;
    background: rgba(0,0,0,0.4);
    backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px);
  }
  .settings-overlay.open { display: flex; align-items: center; justify-content: center; }
  .settings-panel {
    background: var(--card-bg); border-radius: 14px;
    box-shadow: var(--shadow-lg); max-width: 520px; width: 90%;
    max-height: 80vh; overflow-y: auto; padding: 24px;
  }
  .settings-title {
    font-size: 1.1rem; font-weight: 600; margin-bottom: 20px;
    display: flex; align-items: center; justify-content: space-between;
  }
  .settings-close {
    background: none; border: none; font-size: 1.4rem;
    cursor: pointer; color: var(--text-muted); padding: 4px 8px; line-height: 1;
  }
  .settings-section { margin-bottom: 20px; }
  .settings-section h3 {
    font-size: 0.85rem; font-weight: 600; margin-bottom: 10px;
    color: var(--text-muted); letter-spacing: 0.05em;
  }
  .closure-day-grid {
    display: grid; grid-template-columns: repeat(7, 1fr);
    gap: 6px; margin-bottom: 12px;
  }
  .closure-day-btn {
    padding: 8px 4px; border-radius: 8px;
    border: 1.5px solid var(--border); background: var(--card-bg);
    font-size: 0.8rem; font-family: 'M PLUS Rounded 1c', sans-serif;
    cursor: pointer; text-align: center; transition: all 0.15s;
  }
  .closure-day-btn.active {
    background: #5a9e6f; color: white; border-color: #5a9e6f;
  }
  .custom-closure-list {
    max-height: 200px; overflow-y: auto; margin-bottom: 10px;
  }
  .custom-closure-item {
    display: flex; align-items: center; justify-content: space-between;
    padding: 8px 10px; border-radius: 6px; background: var(--closure-bg);
    margin-bottom: 4px; font-size: 0.82rem;
  }
  .custom-closure-item .remove-btn {
    background: none; border: none; color: #c0392b;
    cursor: pointer; font-size: 1rem; padding: 2px 6px;
  }

  .view-hidden { display: none !important; }
</style>
</head>
<body>

<header class="app-header">
  <div class="app-title">
    <div class="app-title-icon">üìÖ</div>
    <span>Ë®∫ÂØüÊó•„Ç´„É¨„É≥„ÉÄ„Éº</span>
  </div>
  <div class="header-center">
    <span class="header-date" id="headerDate"></span>
    <div class="mode-toggle">
      <button class="mode-toggle-btn active" id="modeSingle" onclick="setMode('single')">1ÊúàË°®Á§∫</button>
      <button class="mode-toggle-btn" id="modeScroll" onclick="setMode('scroll')">‰∏ÄË¶ß</button>
    </div>
  </div>
  <div class="header-actions">
    <button class="header-btn" onclick="goToday()">‰ªäÊó•</button>
    <button class="header-btn" onclick="openSettings()">‚öô Ë®≠ÂÆö</button>
  </div>
</header>

<div class="main-area">
  <!-- SINGLE MONTH VIEW -->
  <div class="single-view" id="singleView">
    <div class="legend">
      <div class="legend-item"><div class="legend-dot" style="background:rgba(230,126,34,0.5)"></div>‰ªäÊó•</div>
      <div class="legend-item"><div class="legend-dot" style="background:var(--sunday-text)"></div>Êó•Êõú</div>
      <div class="legend-item"><div class="legend-dot" style="background:var(--saturday-text)"></div>ÂúüÊõú</div>
      <div class="legend-item"><div class="legend-dot" style="background:var(--holiday-text)"></div>Á•ùÊó•</div>
      <div class="legend-item"><div class="legend-dot" style="background:#5a9e6f"></div>‰ºëË®∫</div>
      <div class="legend-item" style="margin-left:auto; font-family:'Nunito',sans-serif; font-size:0.78rem; color:#c0392b;">
        -3=3Êó•Ââç„ÄÄ0=‰ªäÊó•„ÄÄ+3=3Êó•Âæå
      </div>
    </div>
    <div class="month-nav">
      <div class="month-nav-title" id="singleMonthTitle"></div>
    </div>
    <div class="single-month-body">
      <div class="swipe-area" id="swipeArea">
        <div class="single-month-card" id="singleMonthCard"></div>
      </div>
    </div>
  </div>

  <!-- SCROLL VIEW -->
  <div class="scroll-view view-hidden" id="scrollView">
    <div class="legend">
      <div class="legend-item"><div class="legend-dot" style="background:rgba(230,126,34,0.5)"></div>‰ªäÊó•</div>
      <div class="legend-item"><div class="legend-dot" style="background:var(--sunday-text)"></div>Êó•Êõú</div>
      <div class="legend-item"><div class="legend-dot" style="background:var(--saturday-text)"></div>ÂúüÊõú</div>
      <div class="legend-item"><div class="legend-dot" style="background:var(--holiday-text)"></div>Á•ùÊó•</div>
      <div class="legend-item"><div class="legend-dot" style="background:#5a9e6f"></div>‰ºëË®∫</div>
      <div class="legend-item" style="margin-left:auto; font-family:'Nunito',sans-serif; font-size:0.78rem; color:#c0392b;">
        -3=3Êó•Ââç„ÄÄ0=‰ªäÊó•„ÄÄ+3=3Êó•Âæå
      </div>
    </div>
    <div class="scroll-content" id="scrollContent">
      <div class="calendar-grid" id="calendarGrid"></div>
    </div>
  </div>
</div>

<button class="today-fab" onclick="goToday()">‰ªäÊó•</button>

<!-- Closure Popup -->
<div class="closure-popup-overlay" id="closurePopup" onclick="closePopupOutside(event)">
  <div class="closure-popup" onclick="event.stopPropagation()">
    <div class="closure-popup-title">‰ºëË®∫Êó•„ÇíË®≠ÂÆö</div>
    <div class="closure-popup-date" id="popupDate"></div>
    <div class="closure-popup-label">„Åì„ÅÆÊó•„Åã„Çâ‰ΩïÊó•ÈñìÔºü</div>
    <div class="closure-days-grid" id="popupDaysGrid"></div>
    <div class="closure-popup-actions">
      <button class="popup-cancel-btn" onclick="closePopup()">„Ç≠„É£„É≥„Çª„É´</button>
    </div>
  </div>
</div>

<!-- Settings -->
<div class="settings-overlay" id="settingsOverlay" onclick="closeSettingsOutside(event)">
  <div class="settings-panel" onclick="event.stopPropagation()">
    <div class="settings-title">
      <span>‚öô „Ç´„É¨„É≥„ÉÄ„ÉºË®≠ÂÆö</span>
      <button class="settings-close" onclick="closeSettings()">‚úï</button>
    </div>
    <div class="settings-section">
      <h3>ÂÆö‰ºëÊó•ÔºàÊØéÈÄ±„ÅÆ‰ºëË®∫ÊõúÊó•Ôºâ</h3>
      <div class="closure-day-grid" id="closureDayGrid"></div>
    </div>
    <div class="settings-section">
      <h3>Ëá®ÊôÇ‰ºëË®∫Êó•‰∏ÄË¶ß</h3>
      <div class="custom-closure-list" id="customClosureList"></div>
      <p style="font-size:0.75rem; color:var(--text-muted); margin-top:8px;">‚Äª „Ç´„É¨„É≥„ÉÄ„Éº„ÅÆÊó•‰ªò„Çí„Çø„ÉÉ„Éó„Åó„Å¶‰ºëË®∫Êó•„ÇíËøΩÂä†„Åß„Åç„Åæ„Åô</p>
    </div>
    <div class="settings-section">
      <h3>Ë°®Á§∫ÁØÑÂõ≤Ôºà‰∏ÄË¶ß„É¢„Éº„ÉâÔºâ</h3>
      <div style="display:flex; gap:8px; align-items:center; font-size:0.85rem;">
        <span>Ââç</span>
        <select id="monthsBefore" onchange="saveSettings(); renderScrollView()" style="padding:6px 10px; border-radius:6px; border:1.5px solid var(--border); font-family:'M PLUS Rounded 1c',sans-serif;">
          <option value="1">1„É∂Êúà</option><option value="2">2„É∂Êúà</option>
          <option value="3" selected>3„É∂Êúà</option><option value="6">6„É∂Êúà</option>
        </select>
        <span>„Äú Âæå</span>
        <select id="monthsAfter" onchange="saveSettings(); renderScrollView()" style="padding:6px 10px; border-radius:6px; border:1.5px solid var(--border); font-family:'M PLUS Rounded 1c',sans-serif;">
          <option value="3">3„É∂Êúà</option><option value="6">6„É∂Êúà</option>
          <option value="9" selected>9„É∂Êúà</option><option value="12">12„É∂Êúà</option>
        </select>
      </div>
    </div>
  </div>
</div>

<script>
const HOLIDAYS = {
  '2025-01-01':'ÂÖÉÊó•','2025-01-13':'Êàê‰∫∫„ÅÆÊó•','2025-02-11':'Âª∫ÂõΩË®òÂøµ„ÅÆÊó•','2025-02-23':'Â§©ÁöáË™ïÁîüÊó•','2025-02-24':'ÊåØÊõø‰ºëÊó•',
  '2025-03-20':'Êò•ÂàÜ„ÅÆÊó•','2025-04-29':'Êò≠Âíå„ÅÆÊó•','2025-05-03':'ÊÜ≤Ê≥ïË®òÂøµÊó•','2025-05-04':'„Åø„Å©„Çä„ÅÆÊó•','2025-05-05':'„Åì„Å©„ÇÇ„ÅÆÊó•',
  '2025-05-06':'ÊåØÊõø‰ºëÊó•','2025-07-21':'Êµ∑„ÅÆÊó•','2025-08-11':'Â±±„ÅÆÊó•','2025-09-15':'Êï¨ËÄÅ„ÅÆÊó•','2025-09-23':'ÁßãÂàÜ„ÅÆÊó•',
  '2025-10-13':'„Çπ„Éù„Éº„ÉÑ„ÅÆÊó•','2025-11-03':'ÊñáÂåñ„ÅÆÊó•','2025-11-23':'Âã§Âä¥ÊÑüË¨ù„ÅÆÊó•','2025-11-24':'ÊåØÊõø‰ºëÊó•',
  '2026-01-01':'ÂÖÉÊó•','2026-01-12':'Êàê‰∫∫„ÅÆÊó•','2026-02-11':'Âª∫ÂõΩË®òÂøµ„ÅÆÊó•','2026-02-23':'Â§©ÁöáË™ïÁîüÊó•',
  '2026-03-20':'Êò•ÂàÜ„ÅÆÊó•','2026-04-29':'Êò≠Âíå„ÅÆÊó•','2026-05-03':'ÊÜ≤Ê≥ïË®òÂøµÊó•','2026-05-04':'„Åø„Å©„Çä„ÅÆÊó•','2026-05-05':'„Åì„Å©„ÇÇ„ÅÆÊó•',
  '2026-05-06':'ÊåØÊõø‰ºëÊó•','2026-07-20':'Êµ∑„ÅÆÊó•','2026-08-11':'Â±±„ÅÆÊó•','2026-09-21':'Êï¨ËÄÅ„ÅÆÊó•','2026-09-22':'ÂõΩÊ∞ë„ÅÆ‰ºëÊó•',
  '2026-09-23':'ÁßãÂàÜ„ÅÆÊó•','2026-10-12':'„Çπ„Éù„Éº„ÉÑ„ÅÆÊó•','2026-11-03':'ÊñáÂåñ„ÅÆÊó•','2026-11-23':'Âã§Âä¥ÊÑüË¨ù„ÅÆÊó•',
  '2027-01-01':'ÂÖÉÊó•','2027-01-11':'Êàê‰∫∫„ÅÆÊó•','2027-02-11':'Âª∫ÂõΩË®òÂøµ„ÅÆÊó•','2027-02-23':'Â§©ÁöáË™ïÁîüÊó•',
  '2027-03-21':'Êò•ÂàÜ„ÅÆÊó•','2027-03-22':'ÊåØÊõø‰ºëÊó•','2027-04-29':'Êò≠Âíå„ÅÆÊó•','2027-05-03':'ÊÜ≤Ê≥ïË®òÂøµÊó•','2027-05-04':'„Åø„Å©„Çä„ÅÆÊó•',
  '2027-05-05':'„Åì„Å©„ÇÇ„ÅÆÊó•','2027-07-19':'Êµ∑„ÅÆÊó•','2027-08-11':'Â±±„ÅÆÊó•','2027-09-20':'Êï¨ËÄÅ„ÅÆÊó•','2027-09-23':'ÁßãÂàÜ„ÅÆÊó•',
  '2027-10-11':'„Çπ„Éù„Éº„ÉÑ„ÅÆÊó•','2027-11-03':'ÊñáÂåñ„ÅÆÊó•','2027-11-23':'Âã§Âä¥ÊÑüË¨ù„ÅÆÊó•',
};
const WEEKDAYS = ['Êó•','Êúà','ÁÅ´','Ê∞¥','Êú®','Èáë','Âúü'];

let settings = {
  regularClosures: [],
  customClosures: [], // { date: 'YYYY-MM-DD' }
  monthsBefore: 3, monthsAfter: 9, mode: 'single',
};
let currentYear, currentMonth;
let popupStartDate = null;

// Helpers
function dateKey(d) {
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
}
function getToday() { const n=new Date(); return new Date(n.getFullYear(),n.getMonth(),n.getDate()); }
function dayDiff(d) { return Math.round((d-getToday())/86400000); }
function fmtCount(diff) { return diff===0?'0':diff>0?`+${diff}`:`${diff}`; }
function parseDateStr(s) { return new Date(s+'T00:00:00'); }

// Settings
function loadSettings() {
  try { const s=JSON.parse(localStorage.getItem('clinicCal3')); if(s) settings={...settings,...s}; } catch(e){}
  document.getElementById('monthsBefore').value=settings.monthsBefore;
  document.getElementById('monthsAfter').value=settings.monthsAfter;
}
function saveSettings() {
  settings.monthsBefore=parseInt(document.getElementById('monthsBefore').value);
  settings.monthsAfter=parseInt(document.getElementById('monthsAfter').value);
  try { localStorage.setItem('clinicCal3',JSON.stringify(settings)); } catch(e){}
}

// Settings UI
function renderClosureDayGrid() {
  const g=document.getElementById('closureDayGrid'); g.innerHTML='';
  WEEKDAYS.forEach((name,i) => {
    const b=document.createElement('button');
    b.className='closure-day-btn'+(settings.regularClosures.includes(i)?' active':'');
    b.textContent=name;
    b.onclick=()=>{ const idx=settings.regularClosures.indexOf(i); if(idx>=0)settings.regularClosures.splice(idx,1); else settings.regularClosures.push(i); saveSettings(); renderClosureDayGrid(); renderAll(); };
    g.appendChild(b);
  });
}
function renderCustomClosureList() {
  const list=document.getElementById('customClosureList'); list.innerHTML='';
  const sorted=[...settings.customClosures].sort((a,b)=>a.date.localeCompare(b.date));
  // Group consecutive dates
  let groups=[], curr=null;
  sorted.forEach(c => {
    const d=parseDateStr(c.date);
    if(curr && (d-parseDateStr(curr.end))===86400000) { curr.end=c.date; curr.count++; }
    else { curr={start:c.date, end:c.date, count:1}; groups.push(curr); }
  });
  groups.forEach(g => {
    const ds=parseDateStr(g.start), de=parseDateStr(g.end);
    const item=document.createElement('div');
    item.className='custom-closure-item';
    let label=`${ds.getMonth()+1}/${ds.getDate()}(${WEEKDAYS[ds.getDay()]})`;
    if(g.count>1) label+=` „Äú ${de.getMonth()+1}/${de.getDate()}(${WEEKDAYS[de.getDay()]})  ${g.count}Êó•Èñì`;
    item.innerHTML=`<span>${label}</span><button class="remove-btn" onclick="removeClosureGroup('${g.start}',${g.count})">‚úï</button>`;
    list.appendChild(item);
  });
}
function removeClosureGroup(startStr, count) {
  const start=parseDateStr(startStr);
  for(let i=0;i<count;i++){
    const d=new Date(start); d.setDate(d.getDate()+i);
    const ds=dateKey(d);
    settings.customClosures=settings.customClosures.filter(c=>c.date!==ds);
  }
  saveSettings(); renderCustomClosureList(); renderAll();
}
function openSettings() { renderClosureDayGrid(); renderCustomClosureList(); document.getElementById('settingsOverlay').classList.add('open'); }
function closeSettings() { document.getElementById('settingsOverlay').classList.remove('open'); }
function closeSettingsOutside(e) { if(e.target===document.getElementById('settingsOverlay'))closeSettings(); }

// === CLOSURE POPUP ===
function openClosurePopup(dateStr) {
  popupStartDate = dateStr;
  const d = parseDateStr(dateStr);
  document.getElementById('popupDate').textContent =
    `${d.getFullYear()}Âπ¥${d.getMonth()+1}Êúà${d.getDate()}Êó•Ôºà${WEEKDAYS[d.getDay()]}Ôºâ„Åã„Çâ`;

  // Build days grid: 1-10
  const grid = document.getElementById('popupDaysGrid');
  grid.innerHTML = '';
  for(let n=1; n<=10; n++) {
    const btn = document.createElement('button');
    btn.className = 'closure-days-btn';
    const endD = new Date(d); endD.setDate(endD.getDate()+n-1);
    btn.innerHTML = `${n}Êó•<span class="sub">„Äú${endD.getMonth()+1}/${endD.getDate()}</span>`;
    btn.onclick = () => addConsecutiveClosures(dateStr, n);
    grid.appendChild(btn);
  }

  document.getElementById('closurePopup').classList.add('open');
}
function closePopup() { document.getElementById('closurePopup').classList.remove('open'); popupStartDate=null; }
function closePopupOutside(e) { if(e.target===document.getElementById('closurePopup'))closePopup(); }

function addConsecutiveClosures(startStr, days) {
  const start = parseDateStr(startStr);
  for(let i=0; i<days; i++) {
    const d = new Date(start); d.setDate(d.getDate()+i);
    const ds = dateKey(d);
    if(!settings.customClosures.find(c=>c.date===ds)) {
      settings.customClosures.push({date:ds});
    }
  }
  saveSettings(); renderCustomClosureList(); renderAll(); closePopup();
}

// === BUILD MONTH GRID ===
function buildMonthGrid(year, month, container) {
  const grid=document.createElement('div'); grid.className='month-grid';
  WEEKDAYS.forEach((name,i) => {
    const wh=document.createElement('div');
    wh.className='weekday-header'+(i===0?' sun':'')+(i===6?' sat':'');
    wh.textContent=name; grid.appendChild(wh);
  });
  const firstDay=new Date(year,month,1).getDay();
  const daysInMonth=new Date(year,month+1,0).getDate();
  for(let i=0;i<firstDay;i++){ const e=document.createElement('div'); e.className='day-cell empty'; grid.appendChild(e); }

  for(let d=1;d<=daysInMonth;d++){
    const date=new Date(year,month,d), ds=dateKey(date), dow=date.getDay();
    const diff=dayDiff(date);
    const holiday=HOLIDAYS[ds];
    const closure=settings.customClosures.find(c=>c.date===ds);
    const regClosure=settings.regularClosures.includes(dow);

    const cell=document.createElement('div'); cell.className='day-cell';
    if(diff===0) cell.classList.add('today');
    if(dow===0) cell.classList.add('sunday');
    if(dow===6) cell.classList.add('saturday');
    if(diff!==0){
      if(closure) cell.classList.add('closure');
      else if(holiday) cell.classList.add('holiday');
      else if(regClosure&&dow!==0&&dow!==6) cell.classList.add('regular-closure');
    }

    const numEl=document.createElement('div'); numEl.className='day-num'; numEl.textContent=d; cell.appendChild(numEl);
    const countEl=document.createElement('div'); countEl.className='day-count'; countEl.textContent=fmtCount(diff); cell.appendChild(countEl);

    if(holiday){ const l=document.createElement('div'); l.className='day-label'; l.textContent=holiday; cell.appendChild(l); }
    else if(closure){ const l=document.createElement('div'); l.className='day-label'; l.textContent='‰ºëË®∫'; cell.appendChild(l); }
    else if(regClosure&&dow!==0&&dow!==6){ const l=document.createElement('div'); l.className='day-label'; l.textContent='‰ºëË®∫'; cell.appendChild(l); }

    cell.addEventListener('click', (e) => {
      if(cell._swiped) return;
      // If already a custom closure, just remove this single day
      if(settings.customClosures.find(c=>c.date===ds)) {
        settings.customClosures = settings.customClosures.filter(c=>c.date!==ds);
        saveSettings(); renderCustomClosureList(); renderAll();
      } else {
        openClosurePopup(ds);
      }
    });
    grid.appendChild(cell);
  }
  container.appendChild(grid);
}

// Single view
function renderSingleView() {
  document.getElementById('singleMonthTitle').innerHTML=`${currentMonth+1}Êúà<span class="year">${currentYear}</span>`;
  const card=document.getElementById('singleMonthCard'); card.innerHTML='';
  buildMonthGrid(currentYear,currentMonth,card);
}
function navMonth(delta) {
  currentMonth+=delta;
  if(currentMonth>11){currentMonth=0;currentYear++;}
  if(currentMonth<0){currentMonth=11;currentYear--;}
  renderSingleView();
}

// Scroll view
function renderScrollView() {
  const grid=document.getElementById('calendarGrid'); grid.innerHTML='';
  const t=getToday();
  const start=new Date(t.getFullYear(),t.getMonth()-settings.monthsBefore,1);
  const end=new Date(t.getFullYear(),t.getMonth()+settings.monthsAfter,1);
  let cur=new Date(start);
  while(cur<=end){
    const y=cur.getFullYear(),m=cur.getMonth();
    const card=document.createElement('div'); card.className='month-card';
    if(y===t.getFullYear()&&m===t.getMonth()) card.id='scrollCurrentMonth';
    const header=document.createElement('div'); header.className='month-header';
    header.innerHTML=`${m+1}Êúà <span class="month-header-year">${y}</span>`;
    card.appendChild(header);
    buildMonthGrid(y,m,card); grid.appendChild(card);
    cur=new Date(y,m+1,1);
  }
}

// Mode
function setMode(mode) {
  settings.mode=mode; saveSettings();
  document.getElementById('modeSingle').classList.toggle('active',mode==='single');
  document.getElementById('modeScroll').classList.toggle('active',mode==='scroll');
  document.getElementById('singleView').classList.toggle('view-hidden',mode!=='single');
  document.getElementById('scrollView').classList.toggle('view-hidden',mode!=='scroll');
  if(mode==='scroll'){ renderScrollView(); setTimeout(()=>{ const el=document.getElementById('scrollCurrentMonth'); if(el)el.scrollIntoView({behavior:'smooth',block:'center'}); },50); }
  else renderSingleView();
}
function goToday() {
  const t=getToday(); currentYear=t.getFullYear(); currentMonth=t.getMonth();
  if(settings.mode==='single') renderSingleView();
  else { const el=document.getElementById('scrollCurrentMonth'); if(el)el.scrollIntoView({behavior:'smooth',block:'center'}); }
}
function renderAll() { if(settings.mode==='single')renderSingleView(); else renderScrollView(); }

// Swipe on entire single view
(function(){
  let startX=0,startY=0,swiping=false,moved=false;
  const view=document.getElementById('singleView');
  const card=document.getElementById('singleMonthCard');

  view.addEventListener('touchstart',e=>{
    startX=e.touches[0].clientX; startY=e.touches[0].clientY;
    swiping=true; moved=false;
  },{passive:true});

  view.addEventListener('touchmove',e=>{
    if(!swiping) return;
    const dx=e.touches[0].clientX-startX, dy=e.touches[0].clientY-startY;
    if(Math.abs(dx)>15) moved=true;
    if(Math.abs(dx)>20&&Math.abs(dx)>Math.abs(dy)){
      card.style.transform=`translateX(${dx*0.3}px)`;
      card.style.opacity=`${1-Math.abs(dx)*0.0005}`;
    }
  },{passive:true});

  view.addEventListener('touchend',e=>{
    if(!swiping) return; swiping=false;
    const dx=e.changedTouches[0].clientX-startX, dy=e.changedTouches[0].clientY-startY;

    // Mark cells as swiped to prevent click
    if(moved) {
      card.querySelectorAll('.day-cell').forEach(c=>c._swiped=true);
      setTimeout(()=>card.querySelectorAll('.day-cell').forEach(c=>c._swiped=false), 300);
    }

    if(Math.abs(dx)>60&&Math.abs(dx)>Math.abs(dy)*1.2){
      const dir=dx<0?1:-1;
      card.style.transition='transform 0.18s ease-out, opacity 0.18s ease-out';
      card.style.transform=`translateX(${dir*-120}px)`; card.style.opacity='0';
      setTimeout(()=>{
        navMonth(dir);
        card.style.transition='none';
        card.style.transform=`translateX(${dir*120}px)`; card.style.opacity='0';
        requestAnimationFrame(()=>{
          card.style.transition='transform 0.2s ease-out, opacity 0.2s ease-out';
          card.style.transform='translateX(0)'; card.style.opacity='1';
        });
      },180);
    } else {
      card.style.transition='transform 0.15s ease-out, opacity 0.15s ease-out';
      card.style.transform='translateX(0)'; card.style.opacity='1';
    }
  },{passive:true});
})();

// Init
const t=getToday();
currentYear=t.getFullYear(); currentMonth=t.getMonth();
document.getElementById('headerDate').textContent=`${t.getFullYear()}Âπ¥${t.getMonth()+1}Êúà${t.getDate()}Êó•Ôºà${WEEKDAYS[t.getDay()]}Ôºâ`;
loadSettings(); setMode(settings.mode);

function scheduleRefresh(){
  const now=new Date(), tom=new Date(now.getFullYear(),now.getMonth(),now.getDate()+1);
  setTimeout(()=>{ renderAll(); scheduleRefresh(); }, tom-now+1000);
}
scheduleRefresh();
</script>
</body>
</html>
